



# 家庭WiFi布网实战——活用广东电信隐藏福利，换猫+ROS负载均衡600兆公网IP双拨达成！自用网络配置分享~

[TOC]



## 前言

今天刷张大妈，看见有家庭Wifi布网实战的分享。自己一两年前曾经折腾过家里的网络好一阵子，想分享但又找不好很好的机会（其实是懒），今天恰逢张大妈征稿，赶紧写起来。（这就是你咕了较色仪原创的理由？？？！）

民间一直流传着老用户与狗不得办理本套餐的传说，作为电信宽带9年的老用户，来分享一下我如何活用电信隐藏福利，达成600兆宽带记录。

家里的宽带签约是1680包年200M下行，30M上行，送3张40G限速的无限流量卡（40G限速）。但是仔细看看，**我的E家赠送宽带session数[2]**标明可以双拨！而且通过ipip查询也是公网IP~算是10年前套餐的隐藏福利了？

![1558839048408](assets/1558839048408.png)

![1558850063568](assets/1558850063568.png)

## 设备

有了好的网络条件，设备跟不上怎么行。

先上我家的网络拓扑图

![tpology](assets/tpology.png)

### 上机换猫：Huawei SMARTAX MA5671

这个光猫是16年的时候买的了，当时电信送的百兆猫上梅林100兆双拨（一条线插网口，一条线插IPTV口）后经常死机，忍无可忍，加钱换猫。

挑中了Huawei SMARTAX MA5671，主要是因为体积小外加4口千兆RJ-45，应付大流量比以前的百兆猫好多了。

下面是参数：

![1558839724639](assets/1558839724639.png)

简单外观介绍：

![IMG_9125](assets/IMG_9125.jpg)

外包装经典华为牛皮纸包装

![IMG_9128](assets/IMG_9128.jpg)

内容物一览

![IMG_9143](assets/IMG_9143.jpg)

电源适配器，功率为12V-1A

![IMG_9141](assets/IMG_9141.jpg)

正面

![IMG_9147](assets/IMG_9147.jpg)

背面

![IMG_9156](assets/IMG_9156.jpg)

大小大概是两台iPhone 5的样子

![IMG_9161](assets/IMG_9161.jpg)

和电信赠送光猫的对比，华为的真实短小精悍~



在换到新光猫前，你需要拿到旧光猫的超级管理员密码和电信分配给你的LOID。

超级管理员密码我比较幸运，百度了一个就能用了~：账号：telecomadmin，密码：nE7jA%5m

LOID则需要自己去询问电信了。

换猫之后因为要双拨所以选择桥接模式，并且我没有IPTV需求。

![1558840931957](assets/1558840931957.png)

先登录进光猫设置界面

![1558840949549](assets/1558840949549.png)

选择LAN-LAN口工作配置，把四个LAN全部勾选

![1558841075726](assets/1558841075726.png)

回到WAN-WAN配置，新建配置文件，这里贴出我的宽带配置供参考，宽带分配给LAN1-3口。

![1558841114362](assets/1558841114362.png)

IPTV配置，分配给4口。

好的，设置完成，因为是桥接模式，所以其他设置不用去管太多~

### 负载均衡：软路由Mikrotik RB750Gr3

负载均衡部分选择的是Mikrotik RB750Gr3，同样是因为小巧并且有高的可定制性。

外观同样小巧精悍

![img](assets/IMG_1582.jpg)![img](assets/IMG_1583.jpg)



本段参考了Koolshare论坛@[yoohwzy](https://koolshare.cn/space-uid-23511.html) 大大的教程“**使用RouterOS多拨均衡负载，LEDE（OpenWRT）提供其它功能**”，大妈不给贴链接，百度搜索就有了~

本段仅仅摘取中间负载均衡的部分，更详细的的部分还请移步原贴。

1.配置好LAN口网桥：

我这里的配置方案为ether1，ether2为WAN，ether3，ether4，ether5为LAN。

点开Bridge设置，在Bridge选项卡内点新增，全默认即可。

![1558844705392](assets/1558844705392.png)

然后切换到Ports选项卡，将ether3-ehter5加入到刚刚新建的bridge1里面。

![1558844798967](assets/1558844798967.png)

2.新建拨号连接：

点开PPP，在Interface选项卡里面点加号，新建PPPoE Client

![1558844958505](assets/1558844958505.png)

General选项卡下面Interface除选择对应的网口，Dial Out选项卡内填入宽带账号，去掉勾选Add Default Rule 。需要几拨，就添加几个PPPoE，注意Interfaces依次选择，即第一个PPPoE使用ether1，第二个使用ether2，等等.

![1558844994948](assets/1558844994948.png)

![1558844527500](assets/1558844527500.png)

依次添加好后，所有的PPPoE连接前应该都有一个R(Running，已连接)标识。

![1558845149076](assets/1558845149076.png)

3.配置NAT规则

左边菜单选择IP→Firewall，切换到NAT选项卡，点新增。

General选项卡下Chain选择srcnat，Action选项卡下Action选择masquerade，保存。

![1558845359022](assets/1558845359022.png)

4.配置PCC负载均衡

**这一段配置比较复杂 ，不可盲目照抄，请根据自己的实际情况调整！**

先总结一下我的网络，我新增了两个PPPoE Client，分别为pppoe-telecom-out1，pppoe-telecom-out2。

其次对PCC负载均衡的不同算法做简单介绍，此处有部分内容摘自原贴：

---摘录内容

在开始这部分教程之前，我先对不同的“Per Connection Classifier”（PCC，可以理解成负载均衡算法）进行介绍，这段话摘自 《PCC 负载均衡 - EDCwifi 林利钢》 感谢之。
both-address
是以源地址和目的地址作为输入值。
如果数据包的源地址和目的地址相同，则连接被分为一组，将得到相同的哈希值。
然后把所有组进行平分标记(当然也可以不平分标记)。这些数据包将被分配到同一条外网链接上。
both-address是比较稳定的一种设置方法，但不是很平均。

src-address and port
对相同源地址和相同源端口的数据包来说，将会被分配到同一条线路上。这样的话，对于目的地址相同的数据包，也有可能分别走不同的线路，这在对安全性要求比较高的环境中，是不能被接受的。

src address
这种是负载均衡里面最稳健的。在某些环境中，甚至用both adress都会出现问题。但是src-address是所有模式里面均衡效果最差的，因为兼容性和均衡效果不可得兼。

both addrss and ports
是均衡效果最好的。因为带有port的输入参数，引入了port，而port数值从1-65535，因而hash的输入样本大大增加，使数据包平均分流到各条线路的概率也就大大增加了！

---摘录内容结束

a）标记WAN流量

![1558845748754](assets/1558845748754.png)

为每个WAN口都标记一下

b）创建PCC规则

![1558845958320](assets/1558845958320.png)

此处可以使用Src.Address从网段标记，也可以使用In. Interface从接口标记。

需要注意，PCC策略是从0开始计数的，此处2/0表示将数据分成两份，这是第0（两份中的第一份）份数据。那么，下一个PCC规则的PCC策略就应该写2/1。

这个PCC的计数对于常人来说可能有点绕，但是相信在座各位如果有程序员会懂我在说什么xD

c）创建动态路由

![1558846254945](assets/1558846254945.png)

![1558846262696](assets/1558846262696.png)

动态路由分为prerouting和output两个部分，我这里是双拨所以需要4条Mangle规则

全部添加完成后应该是这样的

![1558846331054](assets/1558846331054.png)

5.创建负载均衡路由表



点击左边IP→Routes，点击+新建

![1558846415224](assets/1558846415224.png)

![1558846516323](assets/1558846516323.png)

为每个PPPoE Client添加路由，Distance都选1，Routing Mark分别选每个PPPoE Client对应的就可以。

6.创建故障转移路由表

![1558846584311](assets/1558846584311.png)

![1558846596150](assets/1558846596150.png)

在创建故障转移路由表时要注意，Distance第一个使用1，第二个使用2，如此类推故障转移才有意义。



![1558846692497](assets/1558846692497.png)

7.分配内网地址

点击IP→Address，点击+号为bridge1分配内网IP

这里分配192.168.2.1/24

![1558846802559](assets/1558846802559.png)

### 二级路由/AP

二级路由用的是网件R6300v2，这个路由应该也算是爆款了~

刷入的梅林系统，应该很多人用过，也曾经有值友写过相关文章，这里就不再赘述~

先进入WAN口设置，WAN类型选静态IP，IP地址选上一节给bridge1分配的地址的相同网段即可，这里选择192.168.2.10

![1558846991792](assets/1558846991792.png)

WiFi部分，2.4Ghz只连着一个打印机，就随意了；5G部分用路由自带Site Survey选择了占用较少，同时也能支援Nitendo Switch 5G频段的64频段，频宽80Mhz

![1558847294373](assets/1558847294373.png)

其他软件中心什麼的相信各位已经很熟悉，就不赘述了。

## 性能测试：

有线：

![1558847455565](assets/1558847455565.png)

有线下行輕鬆600兆，可以看到winbox内每条PPPoE跑出了300兆的带宽。

![1558847491837](assets/1558847491837.png)

无线测试：

测试设备iPad Pro 11寸，iOS12.2

![img](assets/IMG_0651.PNG)

路由器的WiFi性能还是成为了瓶颈。

## 外网映射：

楼主内网有一台群辉挂在R6300v2下面，IP为192.168.1.2，想将DSM的5001映射出去。因为是挂在了二级路由下面，所以映射要经过两次的dstnat。

ROS：把WAN端口映射到路由器上

左边菜单打开IP→Firewall，NAT选项卡点击+新增nat。

Chain选dstnat，Protocol选tcp，Dst. Port目标端口选5000

![1558848121760](assets/1558848121760.png)

![1558848263823](assets/1558848263823.png)

R6300v2：把ROS映射的端口再映射一次到NAS

![1558848427972](assets/1558848427972.png)

完成~

![img](assets/IMG_1584.jpg)

## 碎碎念：

虽然常调侃“老用户与狗不得办理”，但是其实个人觉得电信在宽带上面给的还算是非常大方得了。

首先，虽然我签约签的是200兆，但是电信每条宽带都给了100兆的冗余，实际单条是300兆的宽带，光这一点就绝了非常的良心了~

其次，电信给了两个拨号Session，默许了双拨，并且每个PPPoE都有公网IP的分配，算是老用户被电信收贵租的一点点小福利吧~（话说隔壁移动一直说送我宽带，免月租来着xD，但是电信宽带网络质量确实是比移动好上不少）

再者，600兆的宽带有什么用？除了看着爽！除了下载服务器非常好的资源，基本没用...

![1558850012378](assets/1558850012378.png)

![1558849139420](assets/1558849139420.png)

Steam下载不能满速。

![1558849230918](assets/1558849230918.png)

Uplay不能满速

![1558849587038](assets/1558849587038.png)

唯一的好处可能就是上传比较快了吧~

![1558849669594](assets/1558849669594.png)

未来计划？其实想过将签约宽带升级到500兆，这样双拨后就能达成1G带宽了，爽！但是问了下电信说下半年会有资费下降，等等党的胜利！1G之后，就不打算折腾了，毕竟从千兆到万兆所有的网络设备都要更换又是一大笔开销。于是就在千兆退坑吧~

码字不易，如果你喜欢这篇原创请打赏、关注、评论、点赞一条龙。笔者不是专业网络工程师，表述如果有错误还请各位内行人士指出~有其它问题欢迎评论处交流。